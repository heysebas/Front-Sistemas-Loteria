<h2 class="text-xl font-semibold mb-4">Gesti√≥n de Sorteos</h2>

<section class="card">
  <h3 class="font-medium mb-2">Crear nuevo sorteo</h3>

  <form [formGroup]="createForm" (ngSubmit)="onCrearSorteo()" class="form-grid">
    <label>
      Nombre
      <input formControlName="nombre" placeholder="Ej. Sorteo Navidad" />
      <small class="text-red-600" *ngIf="createForm.get('nombre')?.invalid && createForm.get('nombre')?.touched">
        El nombre es obligatorio (m√°x. 80).
      </small>
    </label>

    <label>
      Fecha del sorteo
      <input type="date" formControlName="fechaSorteo" [min]="minDateStr" />
      <small class="text-red-600" *ngIf="createForm.get('fechaSorteo')?.errors?.['fechaPasada']">
        La fecha no puede ser anterior a hoy.
      </small>
      <small class="text-red-600" *ngIf="createForm.get('fechaSorteo')?.errors?.['required'] && createForm.get('fechaSorteo')?.touched">
        La fecha es obligatoria.
      </small>
    </label>

    <div class="two-col">
      <!-- üîπ Cantidad -->
      <label>
        Cantidad de billetes
        <input
          type="number"
          formControlName="cantidad"
          min="1"
          max="10000"
          step="1"
          placeholder="Ej: 1"
        />
        <small class="text-red-600"
               *ngIf="createForm.get('cantidad')?.errors && createForm.get('cantidad')?.touched">
          <ng-container *ngIf="createForm.get('cantidad')?.errors?.['min']">
            La cantidad m√≠nima es 1.
          </ng-container>
          <ng-container *ngIf="createForm.get('cantidad')?.errors?.['max']">
            M√°ximo permitido: 10.000 billetes.
          </ng-container>
        </small>
      </label>

      <!-- üîπ Precio -->
      <label>
        Precio (COP)
        <input
          type="number"
          formControlName="precio"
          min="0"
          max="9999999999.99"
          step="0.01"
          placeholder="Ej: 10000.00"
        />
        <small class="text-red-600"
               *ngIf="createForm.get('precio')?.errors && createForm.get('precio')?.touched">
          <ng-container *ngIf="createForm.get('precio')?.errors?.['min']">
            El precio no puede ser negativo.
          </ng-container>
          <ng-container *ngIf="createForm.get('precio')?.errors?.['max']">
            M√°ximo permitido: 9,999,999,999.99 COP.
          </ng-container>
        </small>
      </label>
    </div>

    <button [disabled]="creando || createForm.invalid" type="submit">
      {{ creando ? 'Creando...' : 'Crear sorteo' }}
    </button>
    <p *ngIf="createMsg" class="hint mt-2">{{ createMsg }}</p>
  </form>
</section>

<section class="sorteos">
  <h3 class="font-medium mb-2">Sorteos registrados</h3>
  <div *ngIf="!sorteos.length" class="muted">No hay sorteos a√∫n.</div>

  <ul class="sorteos-grid">
    <li
      *ngFor="let s of sorteos"
      class="sorteo-card transition hover:shadow-lg hover:scale-[1.02]"
      [class.opacity-60]="isPasado(s)"
      tabindex="0"
    >
      <div class="titulo text-lg font-semibold" [class.text-blue-700]="!isPasado(s)" [class.text-gray-700]="isPasado(s)">
        {{ s.nombre }}
      </div>

      <div class="fecha text-sm text-gray-600 mb-2">
        {{ s.fechaSorteo | date: 'mediumDate' }}
      </div>

      <div class="resumen flex gap-2 mb-2">
        <div class="pill disponible bg-green-100 text-green-800 px-2 py-1 rounded-md">
          Disponibles <strong>{{ s.disponibles }}</strong>
        </div>
        <div class="pill vendido bg-red-100 text-red-800 px-2 py-1 rounded-md">
          Vendidos <strong>{{ s.vendidos }}</strong>
        </div>
      </div>

      <div class="progress bg-gray-200 rounded-full h-3 mb-1 overflow-hidden">
        <div
          class="progress-fill h-3 rounded-full"
          [class.bg-blue-500]="!isPasado(s)"
          [class.bg-gray-400]="isPasado(s)"
          [style.width.%]="(s.vendidos + s.disponibles) > 0
            ? (s.vendidos * 100) / (s.vendidos + s.disponibles)
            : 0"
        ></div>
      </div>
      <div class="progress-legend text-xs text-gray-500">
        {{ s.vendidos }} / {{ s.vendidos + s.disponibles }} vendidos
      </div>

      <!-- Acciones -->
      <div class="text-center mt-3" *ngIf="!isPasado(s); else finalizadoAcciones">
        <button
          type="button"
          class="btn-venta text-white px-3 py-1 rounded-md bg-blue-600 hover:bg-blue-700"
          (click)="irAVenta(s.id)"
        >
          Vender boletas
        </button>
      </div>
      <ng-template #finalizadoAcciones>
        <div class="text-center mt-3">
          <button
            type="button"
            class="text-white px-3 py-1 rounded-md bg-sky-500 hover:bg-sky-600"
            (click)="abrirDetalleFinalizado(s)"
          >
            Ver detalle de ventas
          </button>
        </div>
      </ng-template>
    </li>
  </ul>
</section>

<!-- ===================== MODAL DETALLE FINALIZADO ===================== -->
<div class="modal-backdrop" *ngIf="detalleAbierto" (click)="cerrarDetalle()"></div>

<div
  class="modal"
  role="dialog"
  aria-modal="true"
  *ngIf="detalleAbierto && detalleSorteo as ds"
>
  <header class="modal-header">
    <h3 class="modal-title">
      Ventas ‚Äî {{ ds.nombre }} ({{ ds.fechaSorteo | date:'mediumDate' }})
    </h3>
    <button class="modal-close" (click)="cerrarDetalle()" aria-label="Cerrar">√ó</button>
  </header>

  <section class="modal-body">
    <div *ngIf="getEstado(ds.id).loading" class="hint">Cargando ventas‚Ä¶</div>
    <div *ngIf="getEstado(ds.id).error" class="text-red-600">
      {{ getEstado(ds.id).error }}
    </div>

    <ng-container *ngIf="!getEstado(ds.id).loading && !getEstado(ds.id).error">
      <div *ngIf="!getEstado(ds.id).items.length" class="muted">
        No hay ventas registradas para este sorteo.
      </div>

      <table *ngIf="getEstado(ds.id).items.length" class="tabla w-full">
        <thead>
        <tr>
          <th class="text-left">#</th>
          <th class="text-left">Cliente</th>
          <th class="text-left">Billete</th>
          <th class="text-left">Precio</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let it of getEstado(ds.id).items; index as i">
          <td>{{ i + 1 }}</td>
          <td>
            {{ it.nombre }}
            <small class="text-gray-500" *ngIf="it.correo">({{ it.correo }})</small>
          </td>
          <td>#{{ it.numero }}</td>
          <td>{{ it.precio | currency:'COP':'symbol':'1.0-0' }}</td>
        </tr>
        </tbody>
      </table>

      <div class="total mt-2 text-right font-semibold" *ngIf="getEstado(ds.id).items.length">
        Total vendido: {{ getEstado(ds.id).total | currency:'COP':'symbol':'1.0-0' }}
      </div>
    </ng-container>
  </section>

  <footer class="modal-footer">
    <button class="btn" (click)="cerrarDetalle()">Cerrar</button>
  </footer>
</div>
<!-- =================== /MODAL DETALLE FINALIZADO =================== -->

<!-- ============ OVERLAY DE CARGA ============ -->
<div class="overlay" *ngIf="generando" role="alert" aria-live="assertive">
  <div class="overlay-card" role="dialog" aria-modal="true">
    <div class="spinner" aria-hidden="true"></div>
    <h4 class="mt-2 font-semibold">{{ genMsg || 'Generando billetes‚Ä¶' }}</h4>
    <p class="text-sm text-gray-400 mt-1">
      Esto puede tardar unos segundos si la cantidad es alta.
    </p>

    <div class="progress bg-gray-700 rounded-full h-2 w-full mt-3 overflow-hidden">
      <div class="progress-fill h-2 bg-sky-500" [style.width.%]="genProgress"></div>
    </div>

    <div class="text-xs text-gray-400 mt-1">{{ genProgress | number:'1.0-0' }}%</div>
  </div>
</div>
<!-- ============ /OVERLAY DE CARGA ============ -->
